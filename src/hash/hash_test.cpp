#include <algorithm>
#include <cstdio>
#include <variant>
#include <vector>

#include "hash.hpp"

using namespace crypto;
using B = std::byte;
using hash_algorithms_t =
    std::variant<sha256_hash, sha256_224_hash, sha512_hash, sha512_224_hash,
                 sha512_256_hash>;

struct testcase_t {
  hash_algorithms_t hash_algorithm;
  std::string_view string;
  std::vector<std::byte> digest;
};

std::array<testcase_t, 18> testcases{
    {{sha256_hash(),
      "",
      {B{0xe3}, B{0xb0}, B{0xc4}, B{0x42}, B{0x98}, B{0xfc}, B{0x1c}, B{0x14},
       B{0x9a}, B{0xfb}, B{0xf4}, B{0xc8}, B{0x99}, B{0x6f}, B{0xb9}, B{0x24},
       B{0x27}, B{0xae}, B{0x41}, B{0xe4}, B{0x64}, B{0x9b}, B{0x93}, B{0x4c},
       B{0xa4}, B{0x95}, B{0x99}, B{0x1b}, B{0x78}, B{0x52}, B{0xb8}, B{0x55}}},
     {sha256_hash(),
      "a",
      {B{0xca}, B{0x97}, B{0x81}, B{0x12}, B{0xca}, B{0x1b}, B{0xbd}, B{0xca},
       B{0xfa}, B{0xc2}, B{0x31}, B{0xb3}, B{0x9a}, B{0x23}, B{0xdc}, B{0x4d},
       B{0xa7}, B{0x86}, B{0xef}, B{0xf8}, B{0x14}, B{0x7c}, B{0x4e}, B{0x72},
       B{0xb9}, B{0x80}, B{0x77}, B{0x85}, B{0xaf}, B{0xee}, B{0x48}, B{0xbb}}},
     {sha256_hash(),
      "bmWgj6pFf2NWRPGJaZTq naxmTjVYhnJbZbYy9Ux3 pJeNuO3J4dE7b75HkoMM 8",
      {B{0x60}, B{0x16}, B{0x81}, B{0x6b}, B{0xf6}, B{0x7a}, B{0xdd}, B{0x89},
       B{0x75}, B{0x48}, B{0xd5}, B{0xbc}, B{0xa4}, B{0xa8}, B{0xa3}, B{0xef},
       B{0xfc}, B{0x5d}, B{0x21}, B{0x7c}, B{0xdb}, B{0x92}, B{0x79}, B{0x5e},
       B{0x79}, B{0xbe}, B{0xb3}, B{0x5d}, B{0x31}, B{0xe3}, B{0x47}, B{0xf9}}},
     {sha256_hash(),
      "SHe9a6$evjFzdyowF#hzzMmlZwRbclm2!!4oy5j7IdALLY06Abl9VyRjR7H*^"
      "RRlZ0PjgIJQ9sAC_-KoB10YqYjx3HcqvUWF%$@nax8OrRj5KPJ",
      {B{0xaa}, B{0x48}, B{0xc0}, B{0xbb}, B{0x3a}, B{0x04}, B{0xfb}, B{0x7d},
       B{0xa9}, B{0xc6}, B{0x3c}, B{0x6a}, B{0x81}, B{0x05}, B{0x3b}, B{0xe2},
       B{0x25}, B{0x26}, B{0xa6}, B{0xc1}, B{0x2c}, B{0xd7}, B{0xf4}, B{0x92},
       B{0x97}, B{0xa9}, B{0x47}, B{0x45}, B{0xfe}, B{0x29}, B{0xc3}, B{0x34}}},
     {sha256_224_hash(),
      "abcdefghij",
      {B{0xd3}, B{0x5e}, B{0x1e}, B{0x5a}, B{0xf2}, B{0x9d}, B{0xdb},
       B{0x0d}, B{0x7e}, B{0x15}, B{0x43}, B{0x57}, B{0xdf}, B{0x4a},
       B{0xd9}, B{0x84}, B{0x2a}, B{0xfe}, B{0xe5}, B{0x27}, B{0xc6},
       B{0x89}, B{0xee}, B{0x54}, B{0x7f}, B{0x75}, B{0x31}, B{0x88}}},
     {sha256_224_hash(),
      "How can you write a big system without C++?  -Paul Glick",
      {B{0x86}, B{0xed}, B{0x2e}, B{0xaa}, B{0x9c}, B{0x75}, B{0xba},
       B{0x98}, B{0x39}, B{0x6e}, B{0x5c}, B{0x9f}, B{0xb2}, B{0xf6},
       B{0x79}, B{0xec}, B{0xf0}, B{0xea}, B{0x2e}, B{0xd1}, B{0xe0},
       B{0xee}, B{0x9c}, B{0xee}, B{0xcb}, B{0x4a}, B{0x93}, B{0x32}}},
     {sha256_224_hash(),
      "6RT5wsQLCmYRFUn1kkoRV4tc9PEbq3o6hLz4NWlJymG5D9MJ12dUR7FwoPi07a2",
      {B{0x6e}, B{0xa7}, B{0xb2}, B{0xc4}, B{0xac}, B{0xec}, B{0xb2},
       B{0xd3}, B{0x7b}, B{0x16}, B{0x07}, B{0xa8}, B{0x16}, B{0xd6},
       B{0x67}, B{0x1a}, B{0xd2}, B{0x70}, B{0xa5}, B{0x7e}, B{0xfb},
       B{0x62}, B{0x17}, B{0xf9}, B{0xd9}, B{0xe1}, B{0x22}, B{0x47}}},
     {sha512_hash(),
      "",
      {B{0xcf}, B{0x83}, B{0xe1}, B{0x35}, B{0x7e}, B{0xef}, B{0xb8}, B{0xbd},
       B{0xf1}, B{0x54}, B{0x28}, B{0x50}, B{0xd6}, B{0x6d}, B{0x80}, B{0x07},
       B{0xd6}, B{0x20}, B{0xe4}, B{0x05}, B{0x0b}, B{0x57}, B{0x15}, B{0xdc},
       B{0x83}, B{0xf4}, B{0xa9}, B{0x21}, B{0xd3}, B{0x6c}, B{0xe9}, B{0xce},
       B{0x47}, B{0xd0}, B{0xd1}, B{0x3c}, B{0x5d}, B{0x85}, B{0xf2}, B{0xb0},
       B{0xff}, B{0x83}, B{0x18}, B{0xd2}, B{0x87}, B{0x7e}, B{0xec}, B{0x2f},
       B{0x63}, B{0xb9}, B{0x31}, B{0xbd}, B{0x47}, B{0x41}, B{0x7a}, B{0x81},
       B{0xa5}, B{0x38}, B{0x32}, B{0x7a}, B{0xf9}, B{0x27}, B{0xda}, B{0x3e}}},
     {sha512_hash(),
      "a",
      {B{0x1f}, B{0x40}, B{0xfc}, B{0x92}, B{0xda}, B{0x24}, B{0x16}, B{0x94},
       B{0x75}, B{0x09}, B{0x79}, B{0xee}, B{0x6c}, B{0xf5}, B{0x82}, B{0xf2},
       B{0xd5}, B{0xd7}, B{0xd2}, B{0x8e}, B{0x18}, B{0x33}, B{0x5d}, B{0xe0},
       B{0x5a}, B{0xbc}, B{0x54}, B{0xd0}, B{0x56}, B{0x0e}, B{0x0f}, B{0x53},
       B{0x02}, B{0x86}, B{0x0c}, B{0x65}, B{0x2b}, B{0xf0}, B{0x8d}, B{0x56},
       B{0x02}, B{0x52}, B{0xaa}, B{0x5e}, B{0x74}, B{0x21}, B{0x05}, B{0x46},
       B{0xf3}, B{0x69}, B{0xfb}, B{0xbb}, B{0xce}, B{0x8c}, B{0x12}, B{0xcf},
       B{0xc7}, B{0x95}, B{0x7b}, B{0x26}, B{0x52}, B{0xfe}, B{0x9a}, B{0x75}}},
     {sha512_hash(),
      "bmWgj6pFf2NWRPGJaZTq naxmTjVYhnJbZbYy9Ux3 pJeNuO3J4dE7b75HkoMM 8",
      {B{0xce}, B{0x89}, B{0x6d}, B{0x69}, B{0x42}, B{0xeb}, B{0xb5}, B{0x00},
       B{0x5d}, B{0x0a}, B{0x7b}, B{0xd0}, B{0xd2}, B{0x09}, B{0xa2}, B{0xd9},
       B{0xc1}, B{0xc7}, B{0x30}, B{0x8e}, B{0x04}, B{0xe8}, B{0xdf}, B{0xc3},
       B{0x82}, B{0xf1}, B{0x95}, B{0xf8}, B{0x66}, B{0xec}, B{0x24}, B{0x8f},
       B{0xeb}, B{0x4b}, B{0x0f}, B{0x8d}, B{0x92}, B{0x83}, B{0xfd}, B{0x1c},
       B{0x4f}, B{0xd9}, B{0x75}, B{0x6a}, B{0x26}, B{0x34}, B{0x08}, B{0xd9},
       B{0xaa}, B{0x30}, B{0xc6}, B{0x33}, B{0x6a}, B{0x60}, B{0xba}, B{0xbb},
       B{0x71}, B{0xc0}, B{0x38}, B{0x92}, B{0xe2}, B{0xc9}, B{0xe8}, B{0xbb}}},
     {sha512_hash(),
      "SHe9a6$evjFzdyowF#hzzMmlZwRbclm2!!4oy5j7IdALLY06Abl9VyRjR7H*^"
      "RRlZ0PjgIJQ9sAC_-KoB10YqYjx3HcqvUWF%$@nax8OrRj5KPJ",
      {B{0xb9}, B{0x0c}, B{0xcf}, B{0x39}, B{0xe8}, B{0xb9}, B{0x12}, B{0x72},
       B{0x89}, B{0xed}, B{0xcf}, B{0x7f}, B{0xbf}, B{0x2a}, B{0x33}, B{0x10},
       B{0x40}, B{0x9e}, B{0xb9}, B{0xfe}, B{0x43}, B{0x1f}, B{0x55}, B{0x48},
       B{0xfc}, B{0x09}, B{0x49}, B{0xa4}, B{0xbb}, B{0x64}, B{0x62}, B{0x01},
       B{0x87}, B{0x45}, B{0xf7}, B{0x51}, B{0x1e}, B{0x68}, B{0x27}, B{0xd8},
       B{0xb0}, B{0x27}, B{0x37}, B{0x4f}, B{0xc6}, B{0x5a}, B{0x58}, B{0x87},
       B{0xf6}, B{0xe2}, B{0x3b}, B{0xad}, B{0x10}, B{0x5d}, B{0x97}, B{0x0e},
       B{0xbc}, B{0x40}, B{0x60}, B{0xd3}, B{0x49}, B{0xc7}, B{0x97}, B{0x4d}}},
     {sha512_hash(),
      "6RT5wsQLCmYRFUn1kkoRV4tc9PEbq3o6hLz4NWlJymG5D9MJ12dUR7FwoPi07a2",
      {B{0x0a}, B{0x79}, B{0x2c}, B{0x29}, B{0xfb}, B{0x9e}, B{0x2c}, B{0x8d},
       B{0x75}, B{0x28}, B{0xcd}, B{0x9c}, B{0x5f}, B{0x66}, B{0x5d}, B{0xd3},
       B{0xef}, B{0x8e}, B{0x17}, B{0xb2}, B{0xcb}, B{0xcd}, B{0x21}, B{0xaf},
       B{0x40}, B{0xa2}, B{0x81}, B{0xe2}, B{0xc7}, B{0x8a}, B{0x5f}, B{0xe3},
       B{0x63}, B{0x39}, B{0x34}, B{0xd9}, B{0xf1}, B{0x7d}, B{0x76}, B{0x7e},
       B{0x1a}, B{0x57}, B{0x64}, B{0xf4}, B{0x1f}, B{0x27}, B{0x63}, B{0x71},
       B{0xf2}, B{0xb9}, B{0x14}, B{0x97}, B{0xb0}, B{0x9a}, B{0x46}, B{0x88},
       B{0x1e}, B{0xda}, B{0x48}, B{0xe1}, B{0xc0}, B{0xad}, B{0x0a}, B{0x4d}}},
     {sha512_224_hash(),
      "abcdefghij",
      {B{0xf8}, B{0x09}, B{0x42}, B{0x3c}, B{0xbb}, B{0x25}, B{0xe8},
       B{0x1a}, B{0x2a}, B{0x64}, B{0xae}, B{0xce}, B{0xe2}, B{0xcd},
       B{0x5f}, B{0xdc}, B{0x7d}, B{0x91}, B{0xd5}, B{0xdb}, B{0x58},
       B{0x39}, B{0x01}, B{0xfb}, B{0xf1}, B{0xdb}, B{0x31}, B{0x16}}},
     {sha512_224_hash(),
      "The fugacity of a constituent in a mixture of gases at a given "
      "temperature is proportional to its mole fraction.  Lewis-Randall Rule",
      {B{0x3a}, B{0xd3}, B{0xc8}, B{0x9e}, B{0x15}, B{0xb9}, B{0x1e},
       B{0x62}, B{0x73}, B{0x53}, B{0x4c}, B{0x5d}, B{0x18}, B{0xad},
       B{0xad}, B{0xbb}, B{0x52}, B{0x8e}, B{0x7b}, B{0x84}, B{0x0b},
       B{0x28}, B{0x8f}, B{0x64}, B{0xe8}, B{0x1b}, B{0x8c}, B{0x6d}}},
     {sha512_224_hash(),
      "Even if I could be Shakespeare, I think I should still choose to be "
      "Faraday. - A. Huxley",
      {B{0x05}, B{0xff}, B{0xa7}, B{0x1b}, B{0xb0}, B{0x2e}, B{0x85},
       B{0x5d}, B{0xe1}, B{0xaa}, B{0xee}, B{0x17}, B{0x77}, B{0xb3},
       B{0xbd}, B{0xba}, B{0xf7}, B{0x50}, B{0x76}, B{0x46}, B{0xf1},
       B{0x9c}, B{0x4c}, B{0x6a}, B{0xa2}, B{0x99}, B{0x33}, B{0xd0}}},
     {sha512_256_hash(),
      "abcdefghij",
      {B{0x55}, B{0x07}, B{0x62}, B{0x91}, B{0x3d}, B{0x51}, B{0xee}, B{0xfb},
       B{0xcd}, B{0x1a}, B{0x55}, B{0x06}, B{0x8f}, B{0xcf}, B{0xc9}, B{0xb1},
       B{0x54}, B{0xfd}, B{0x11}, B{0xc1}, B{0x07}, B{0x8b}, B{0x99}, B{0x6d},
       B{0xf0}, B{0xd9}, B{0x26}, B{0xea}, B{0x59}, B{0xd2}, B{0xa6}, B{0x8d}}},
     {sha512_256_hash(),
      "The fugacity of a constituent in a mixture of gases at a given "
      "temperature is proportional to its mole fraction.  Lewis-Randall Rule",
      {B{0x68}, B{0x8f}, B{0xf0}, B{0x3e}, B{0x36}, B{0x76}, B{0x80}, B{0x75},
       B{0x7a}, B{0xa9}, B{0x90}, B{0x6c}, B{0xb1}, B{0xe2}, B{0xad}, B{0x21},
       B{0x8c}, B{0x51}, B{0xf4}, B{0x52}, B{0x6d}, B{0xc0}, B{0x42}, B{0x6e},
       B{0xa2}, B{0x29}, B{0xa5}, B{0xba}, B{0x9d}, B{0x00}, B{0x2c}, B{0x69}}},
     {sha512_256_hash(),
      "Even if I could be Shakespeare, I think I should still choose to be "
      "Faraday. - A. Huxley",
      {B{0xa7}, B{0xa3}, B{0x84}, B{0x60}, B{0x05}, B{0xf8}, B{0xa9},
       B{0x93}, B{0x5a}, B{0x0a}, B{0x2d}, B{0x43}, B{0xe7}, B{0xfd},
       B{0x56}, B{0xd9}, B{0x51}, B{0x32}, B{0xa9}, B{0xa3}, B{0x60},
       B{0x9b}, B{0xf3}, B{0x29}, B{0x6e}, B{0xf8}, B{0x0b}, B{0x82},
       B{0x18}, B{0xac}, B{0xff}, B{0xa0}}}}};

int main(int argc, char *argv[]) {
  int rc = 0;
  std::size_t tcnum = 0, tctotal = testcases.size();

  if (argc > 1) {
    int requested_tcnum = std::atoi(argv[1]);
    if (requested_tcnum < 1 || std::size_t(requested_tcnum) > tctotal) {
      std::printf("\nERROR: Requested testcase number was out of range. Valid "
                  "range is [1-%lu].\n",
                  tctotal);
      std::printf("USAGE: hash_test [testcase#]\n");
      std::printf("NOTE: Do not provide a testcase number in order to run all "
                  "testcases.\n");
      return -1;
    }
    tctotal = (std::size_t)requested_tcnum;
    tcnum = tctotal - 1;
    std::printf("\nTestcase (selected 1 out of %lu):\n", testcases.size());
  } else {
    std::printf("\nTestcases (%lu):\n", tctotal);
  }

  for (; tcnum < tctotal; ++tcnum) {
    std::visit(
        [&tc = testcases[tcnum], &tcnum, &rc](auto &&algorithm) {
          algorithm << tc.string;

          std::printf("%04lu: ", tcnum + 1);
          auto digest = algorithm.get_digest();
          if (std::equal(tc.digest.begin(), tc.digest.end(), digest.begin())) {
            std::printf("passed");
          } else {
            std::printf("failed");
            rc = -1;
          }
          std::printf(" \"%s\"\n", tc.string.data());
        },
        testcases[tcnum].hash_algorithm);
  }

  return rc;
}
